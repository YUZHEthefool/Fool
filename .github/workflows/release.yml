name: Release

# è§¦å‘æ¡ä»¶ï¼šæ¨é€ç¬¦åˆè¯­ä¹‰åŒ–ç‰ˆæœ¬çš„tag (v1.2.3)
on:
  push:
    tags:
      - 'v*.*.*'

# æƒé™ï¼šéœ€è¦å†™æƒé™ä»¥åˆ›å»ºreleaseå’Œæ›´æ–°README
permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # å‡†å¤‡é˜¶æ®µï¼šæå–ç‰ˆæœ¬å·å¹¶éªŒè¯
  prepare:
    name: Prepare and validate version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract.outputs.version }}
      tag_name: ${{ steps.extract.outputs.tag_name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: extract
        run: |
          TAG_NAME="${GITHUB_REF_NAME}"
          VERSION="${TAG_NAME#v}"
          echo "tag_name=${TAG_NAME}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Extracted version: ${VERSION}"

      - name: Verify Cargo.toml version matches tag
        run: |
          CARGO_VERSION=$(grep '^version = ' Cargo.toml | head -n1 | cut -d'"' -f2)
          TAG_VERSION="${{ steps.extract.outputs.version }}"
          echo "Cargo.toml version: ${CARGO_VERSION}"
          echo "Tag version: ${TAG_VERSION}"
          if [ "${CARGO_VERSION}" != "${TAG_VERSION}" ]; then
            echo "::error::Version mismatch: Cargo.toml has ${CARGO_VERSION} but tag is ${TAG_VERSION}"
            exit 1
          fi
          echo "âœ“ Version validation passed"

  # æ„å»ºé˜¶æ®µï¼šå¤šå¹³å°ç¼–è¯‘
  build:
    name: Build for ${{ matrix.target }}
    needs: prepare
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_ext: tar.gz
            use_cross: false

          # macOS x86_64 (Intel)
          - os: macos-13
            target: x86_64-apple-darwin
            artifact_ext: tar.gz
            use_cross: false

          # macOS aarch64 (Apple Silicon)
          - os: macos-14
            target: aarch64-apple-darwin
            artifact_ext: tar.gz
            use_cross: false

          # Windows x86_64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_ext: zip
            use_cross: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      # Linuxå¹³å°éœ€è¦OpenSSLå¼€å‘åº“
      - name: Install build dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libssl-dev

      - name: Setup Rust cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            target
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-cargo-release-
            ${{ runner.os }}-${{ matrix.target }}-cargo-
            ${{ runner.os }}-cargo-

      # æ„å»ºreleaseäºŒè¿›åˆ¶æ–‡ä»¶
      - name: Build release binary
        run: cargo build --release --locked --target ${{ matrix.target }}

      # Unixç³»ç»Ÿï¼ˆLinux/macOSï¼‰æ‰“åŒ…ä¸ºtar.gz
      - name: Package artifact (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail

          VERSION="${{ needs.prepare.outputs.version }}"
          TARGET="${{ matrix.target }}"
          ARCHIVE="fool-${VERSION}-${TARGET}.tar.gz"

          # åˆ›å»ºä¸´æ—¶ç›®å½•å¹¶å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
          mkdir -p "package/fool-${VERSION}"
          cp "target/${TARGET}/release/fool" "package/fool-${VERSION}/"
          cp LICENSE "package/fool-${VERSION}/" || true
          cp README.md "package/fool-${VERSION}/" || true

          # æ‰“åŒ…
          cd package
          tar -czf "../${ARCHIVE}" "fool-${VERSION}"
          cd ..

          # ç”ŸæˆSHA256æ ¡éªŒå’Œ
          shasum -a 256 "${ARCHIVE}" | tee "${ARCHIVE}.sha256"

          echo "Created ${ARCHIVE}"
          ls -lh "${ARCHIVE}"

      # Windowsç³»ç»Ÿæ‰“åŒ…ä¸ºzip
      - name: Package artifact (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $Version = "${{ needs.prepare.outputs.version }}"
          $Target = "${{ matrix.target }}"
          $Archive = "fool-$Version-$Target.zip"

          # åˆ›å»ºä¸´æ—¶ç›®å½•å¹¶å¤åˆ¶æ–‡ä»¶
          New-Item -ItemType Directory -Path "package\fool-$Version" -Force
          Copy-Item "target\$Target\release\fool.exe" "package\fool-$Version\"
          Copy-Item "LICENSE" "package\fool-$Version\" -ErrorAction SilentlyContinue
          Copy-Item "README.md" "package\fool-$Version\" -ErrorAction SilentlyContinue

          # æ‰“åŒ…
          Compress-Archive -Path "package\fool-$Version" -DestinationPath $Archive -Force

          # ç”ŸæˆSHA256æ ¡éªŒå’Œ
          $Hash = (Get-FileHash $Archive -Algorithm SHA256).Hash.ToLower()
          "$Hash  $Archive" | Out-File "$Archive.sha256" -Encoding ASCII -NoNewline

          Write-Host "Created $Archive"
          Get-Item $Archive | Format-List

      # ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.target }}
          path: |
            fool-${{ needs.prepare.outputs.version }}-${{ matrix.target }}.${{ matrix.artifact_ext }}
            fool-${{ needs.prepare.outputs.version }}-${{ matrix.target }}.${{ matrix.artifact_ext }}.sha256
          if-no-files-found: error
          retention-days: 7

  # å‘å¸ƒé˜¶æ®µï¼šåˆ›å»ºGitHub Releaseå¹¶æ›´æ–°README
  publish:
    name: Publish GitHub Release
    needs: [prepare, build]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥ä¾¿ç”Ÿæˆchangelog

      # ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: release-*
          merge-multiple: true
          path: dist

      # åˆ—å‡ºä¸‹è½½çš„æ–‡ä»¶ï¼ˆç”¨äºè°ƒè¯•ï¼‰
      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          ls -lh dist/

      # åˆ›å»ºGitHub Release
      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.prepare.outputs.tag_name }}
          name: Release ${{ needs.prepare.outputs.tag_name }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            dist/**
          body: |
            # ğŸ‰ fool ${{ needs.prepare.outputs.version }}

            ## ğŸ“¦ ä¸‹è½½é“¾æ¥

            | å¹³å° | æ¶æ„ | ä¸‹è½½é“¾æ¥ |
            |------|------|----------|
            | Linux | x86_64 | [fool-${{ needs.prepare.outputs.version }}-x86_64-unknown-linux-gnu.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ needs.prepare.outputs.tag_name }}/fool-${{ needs.prepare.outputs.version }}-x86_64-unknown-linux-gnu.tar.gz) |
            | macOS | x86_64 (Intel) | [fool-${{ needs.prepare.outputs.version }}-x86_64-apple-darwin.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ needs.prepare.outputs.tag_name }}/fool-${{ needs.prepare.outputs.version }}-x86_64-apple-darwin.tar.gz) |
            | macOS | aarch64 (Apple Silicon) | [fool-${{ needs.prepare.outputs.version }}-aarch64-apple-darwin.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ needs.prepare.outputs.tag_name }}/fool-${{ needs.prepare.outputs.version }}-aarch64-apple-darwin.tar.gz) |
            | Windows | x86_64 | [fool-${{ needs.prepare.outputs.version }}-x86_64-pc-windows-msvc.zip](https://github.com/${{ github.repository }}/releases/download/${{ needs.prepare.outputs.tag_name }}/fool-${{ needs.prepare.outputs.version }}-x86_64-pc-windows-msvc.zip) |

            **SHA256æ ¡éªŒå’Œæ–‡ä»¶**: æ¯ä¸ªä¸‹è½½é“¾æ¥éƒ½é™„å¸¦å¯¹åº”çš„ `.sha256` æ–‡ä»¶

            ## ğŸ“ å®‰è£…è¯´æ˜

            ### Linux / macOS
            ```bash
            # ä¸‹è½½å¹¶è§£å‹
            tar -xzf fool-${{ needs.prepare.outputs.version }}-<target>.tar.gz
            cd fool-${{ needs.prepare.outputs.version }}

            # å¯é€‰ï¼šç§»åŠ¨åˆ°ç³»ç»Ÿè·¯å¾„
            sudo mv fool /usr/local/bin/

            # éªŒè¯å®‰è£…
            fool --version
            ```

            ### Windows
            1. ä¸‹è½½ `.zip` æ–‡ä»¶
            2. è§£å‹åˆ°ä»»æ„ç›®å½•
            3. å°†è§£å‹ç›®å½•æ·»åŠ åˆ°ç³»ç»ŸPATHç¯å¢ƒå˜é‡
            4. åœ¨å‘½ä»¤æç¤ºç¬¦ä¸­è¿è¡Œ `fool --version` éªŒè¯å®‰è£…

            ## ğŸ”’ å®‰å…¨æ ¡éªŒ

            ä¸‹è½½åè¯·éªŒè¯SHA256æ ¡éªŒå’Œï¼š

            ```bash
            # Linux / macOS
            shasum -a 256 -c fool-${{ needs.prepare.outputs.version }}-<target>.tar.gz.sha256

            # Windows PowerShell
            Get-FileHash fool-${{ needs.prepare.outputs.version }}-<target>.zip -Algorithm SHA256
            ```

      # æ›´æ–°READMEæ–‡ä»¶ä¸­çš„ç‰ˆæœ¬ä¿¡æ¯å’Œä¸‹è½½é“¾æ¥
      - name: Update README with release information
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
          TAG_NAME: ${{ needs.prepare.outputs.tag_name }}
          REPO: ${{ github.repository }}
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          set -euo pipefail

          echo "Updating README.md with version ${VERSION}..."

          # å…ˆåˆ‡æ¢åˆ°é»˜è®¤åˆ†æ”¯ï¼ˆå¿…é¡»åœ¨ä¿®æ”¹æ–‡ä»¶ä¹‹å‰ï¼‰
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin "${DEFAULT_BRANCH}"
          # ä½¿ç”¨git switchåˆ›å»ºè¿½è¸ªè¿œç¨‹åˆ†æ”¯çš„æœ¬åœ°åˆ†æ”¯ï¼ˆåœ¨å…¨æ–°runnerä¸­ä¹Ÿèƒ½å·¥ä½œï¼‰
          git switch -c "${DEFAULT_BRANCH}" "origin/${DEFAULT_BRANCH}" 2>/dev/null || git checkout "${DEFAULT_BRANCH}"

          # ç¡®ä¿æœ¬åœ°åˆ†æ”¯ä¸è¿œç¨‹åŒæ­¥ï¼ˆå¿…é¡»åœ¨ä¿®æ”¹READMEä¹‹å‰ï¼Œé¿å…rebaseå†²çªï¼‰
          git reset --hard "origin/${DEFAULT_BRANCH}"

          # è·å–tagçš„æ—¥æœŸï¼ˆä½¿ç”¨ç¡®å®šæ€§çš„æ—¥æœŸé¿å…ä¸å¿…è¦çš„commitï¼‰
          export RELEASE_DATE=$(git log -1 --format=%cs "${TAG_NAME}" 2>/dev/null || date -I)

          # ä½¿ç”¨Pythonè„šæœ¬æ›´æ–°README
          python3 - <<'PYTHON_SCRIPT'
          import pathlib
          import re
          import os

          # è¯»å–ç¯å¢ƒå˜é‡
          version = os.environ["VERSION"]
          tag_name = os.environ["TAG_NAME"]
          repo = os.environ["REPO"]
          release_date = os.environ.get("RELEASE_DATE", "unknown")

          # è¯»å–READMEæ–‡ä»¶
          readme_path = pathlib.Path("README.md")
          if not readme_path.exists():
              print(f"Warning: {readme_path} not found, skipping README update")
              exit(0)

          content = readme_path.read_text(encoding="utf-8")

          # CIçŠ¶æ€å¾½ç« ï¼ˆæ³¨æ„ï¼šä¸åŒ…å«æ ‡è®°ï¼Œupsert_sectionä¼šæ·»åŠ ï¼‰
          ci_badge = f"""[![CI](https://github.com/{repo}/actions/workflows/ci.yml/badge.svg)](https://github.com/{repo}/actions/workflows/ci.yml)
          [![Release](https://github.com/{repo}/actions/workflows/release.yml/badge.svg)](https://github.com/{repo}/actions/workflows/release.yml)"""

          # ä¸‹è½½é“¾æ¥åŒºå—ï¼ˆæ³¨æ„ï¼šä¸åŒ…å«æ ‡è®°ï¼Œupsert_sectionä¼šæ·»åŠ ï¼‰
          download_section = f"""## ğŸ“¦ ä¸‹è½½æœ€æ–°ç‰ˆæœ¬

          **å½“å‰ç‰ˆæœ¬**: [{tag_name}](https://github.com/{repo}/releases/tag/{tag_name}) (å‘å¸ƒäº {release_date})

          ### å¿«é€Ÿä¸‹è½½

          | å¹³å° | æ¶æ„ | ä¸‹è½½ |
          |------|------|------|
          | ğŸ§ Linux | x86_64 | [â¬‡ï¸ ä¸‹è½½](https://github.com/{repo}/releases/download/{tag_name}/fool-{version}-x86_64-unknown-linux-gnu.tar.gz) ([æ ¡éªŒå’Œ](https://github.com/{repo}/releases/download/{tag_name}/fool-{version}-x86_64-unknown-linux-gnu.tar.gz.sha256)) |
          | ğŸ macOS | x86_64 (Intel) | [â¬‡ï¸ ä¸‹è½½](https://github.com/{repo}/releases/download/{tag_name}/fool-{version}-x86_64-apple-darwin.tar.gz) ([æ ¡éªŒå’Œ](https://github.com/{repo}/releases/download/{tag_name}/fool-{version}-x86_64-apple-darwin.tar.gz.sha256)) |
          | ğŸ macOS | aarch64 (M1/M2) | [â¬‡ï¸ ä¸‹è½½](https://github.com/{repo}/releases/download/{tag_name}/fool-{version}-aarch64-apple-darwin.tar.gz) ([æ ¡éªŒå’Œ](https://github.com/{repo}/releases/download/{tag_name}/fool-{version}-aarch64-apple-darwin.tar.gz.sha256)) |
          | ğŸªŸ Windows | x86_64 | [â¬‡ï¸ ä¸‹è½½](https://github.com/{repo}/releases/download/{tag_name}/fool-{version}-x86_64-pc-windows-msvc.zip) ([æ ¡éªŒå’Œ](https://github.com/{repo}/releases/download/{tag_name}/fool-{version}-x86_64-pc-windows-msvc.zip.sha256)) |

          ### å®‰è£…è¯´æ˜

          #### Linux / macOS
          ```bash
          # è§£å‹ä¸‹è½½çš„æ–‡ä»¶
          tar -xzf fool-{version}-<target>.tar.gz
          cd fool-{version}

          # ç§»åŠ¨åˆ°ç³»ç»Ÿè·¯å¾„ï¼ˆå¯é€‰ï¼‰
          sudo mv fool /usr/local/bin/

          # éªŒè¯å®‰è£…
          fool --version
          ```

          #### Windows
          1. ä¸‹è½½å¯¹åº”çš„ `.zip` æ–‡ä»¶
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. å°†ç›®å½•æ·»åŠ åˆ°ç³»ç»Ÿ PATH ç¯å¢ƒå˜é‡
          4. æ‰“å¼€å‘½ä»¤æç¤ºç¬¦ï¼Œè¿è¡Œ `fool --version`

          æŸ¥çœ‹ [æ‰€æœ‰ç‰ˆæœ¬](https://github.com/{repo}/releases)"""

          def upsert_section(text, start_marker, end_marker, new_content):
              """æ’å…¥æˆ–æ›´æ–°READMEä¸­çš„æ ‡è®°åŒºå—"""
              pattern = re.compile(
                  re.escape(start_marker) + r".*?" + re.escape(end_marker),
                  re.DOTALL
              )

              replacement = f"{start_marker}\n{new_content.strip()}\n{end_marker}"

              if pattern.search(text):
                  # æ›´æ–°ç°æœ‰åŒºå—
                  result = pattern.sub(replacement, text)
                  print(f"âœ“ Updated existing section between {start_marker} and {end_marker}")
                  return result
              else:
                  # åœ¨æ–‡ä»¶å¼€å¤´æ’å…¥æ–°åŒºå—
                  result = replacement + "\n\n" + text
                  print(f"âœ“ Inserted new section with markers {start_marker} and {end_marker}")
                  return result

          # æ›´æ–°CIå¾½ç« 
          content = upsert_section(
              content,
              "<!-- CI_BADGE_START -->",
              "<!-- CI_BADGE_END -->",
              ci_badge
          )

          # æ›´æ–°ä¸‹è½½åŒºå—
          content = upsert_section(
              content,
              "<!-- DOWNLOAD_START -->",
              "<!-- DOWNLOAD_END -->",
              download_section
          )

          # å†™å›æ–‡ä»¶
          readme_path.write_text(content, encoding="utf-8")
          print(f"\nâœ“ README.md updated successfully for version {version}")
          PYTHON_SCRIPT

      # æäº¤READMEæ›´æ–°åˆ°ä¸»åˆ†æ”¯
      - name: Commit and push README update
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´ï¼ˆåˆ†æ”¯å·²åœ¨ä¸Šä¸€æ­¥åŒæ­¥ï¼‰
          if git diff --quiet README.md; then
            echo "No changes to README.md, skipping commit"
          else
            echo "Committing README.md changes..."
            git add README.md
            git commit -m "docs: update README for release ${VERSION} [skip ci]"

            # æ¨é€æ›´æ–°ï¼ˆä½¿ç”¨[skip ci]é¿å…è§¦å‘CIå¾ªç¯ï¼‰
            if git push origin HEAD:"${DEFAULT_BRANCH}"; then
              echo "âœ“ README.md updated successfully"
            else
              echo "Warning: Failed to push README update (this is non-fatal)"
            fi
          fi
